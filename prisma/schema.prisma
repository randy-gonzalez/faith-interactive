// ==============================================================================
// Faith Interactive - Prisma Schema
// ==============================================================================
// Multi-tenant data model for a church SaaS platform.
// Every table (except Church) has a churchId foreign key for tenant isolation.
// ==============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================================================
// ENUMS
// ==============================================================================

// Platform roles for Fi staff (Platform panel access)
// These are SEPARATE from church roles - a user can have both
enum PlatformRole {
  PLATFORM_ADMIN   // Full access to all /platform features including CRM
  PLATFORM_STAFF   // Read-only or limited access to /platform (no CRM)
  SALES_REP        // CRM access - can see own leads + unassigned leads
}

// Church roles for access control within a tenant
// Admin: full access including user management
// Editor: can create/edit/publish content, no user management
// Viewer: read-only dashboard access
enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

// Church status for tenant management
enum ChurchStatus {
  ACTIVE     // Normal operation
  SUSPENDED  // Public site shows "unavailable", dashboard blocked
}

// Content publication status
enum ContentStatus {
  DRAFT
  PUBLISHED
}

// Form types for the configurable forms system
enum FormType {
  CONTACT         // Default contact form
  PRAYER_REQUEST  // Default prayer request form
  VOLUNTEER       // Default volunteer application form
  CUSTOM          // User-created custom forms
}

// ==============================================================================
// EVENTS ENHANCEMENT ENUMS
// ==============================================================================

// Registration status for event attendees
enum RegistrationStatus {
  REGISTERED   // Confirmed registration
  WAITLISTED   // On waitlist due to capacity
  CANCELLED    // Cancelled by attendee
  CHECKED_IN   // Checked in at event
  NO_SHOW      // Did not attend
}

// Notification channels for reminders
enum NotificationChannel {
  EMAIL
  SMS
  PUSH
}

// Recurrence frequency for recurring events
enum RecurrenceFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  YEARLY
}

// ==============================================================================
// TENANT MODEL
// ==============================================================================
// The Church model represents a tenant in the multi-tenant system.
// Each church has its own isolated data set.
// ==============================================================================

model Church {
  id        String       @id @default(cuid())
  // Subdomain slug - used to identify the tenant from the URL
  // e.g., "grace-community" for grace-community.faithinteractive.com
  slug      String       @unique
  // Display name of the church
  name      String
  // Primary contact email for the church (optional)
  primaryContactEmail String?
  // Status for tenant management (active/suspended)
  status    ChurchStatus @default(ACTIVE)
  // Soft delete support
  deletedAt DateTime?
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - all tenant-scoped data
  memberships         ChurchMembership[]
  sessions            Session[]
  userInvites         UserInvite[]

  // Content types
  pages               Page[]
  globalBlocks        GlobalBlock[]
  sermons             Sermon[]
  events              Event[]
  announcements       Announcement[]
  leadershipProfiles  LeadershipProfile[]

  // Sermon-related entities
  sermonSeries        SermonSeries[]
  speakers            Speaker[]
  sermonTopics        SermonTopic[]

  // Site configuration
  siteSettings        SiteSettings?
  branding            ChurchBranding?
  contactSubmissions  ContactSubmission[]

  // Phase 3: Media + Forms
  media               Media[]
  prayerRequests      PrayerRequest[]
  volunteerSignups    VolunteerSignup[]

  // Configurable Forms System
  forms               Form[]
  formSubmissions     FormSubmission[]
  formFiles           FormFile[]

  // Phase 4: Domains & Launch Tools
  customDomains       CustomDomain[]
  redirectRules       RedirectRule[]
  launchChecklist     LaunchChecklistItem[]

  // Events Enhancement
  venues              Venue[]
  eventRegistrations  EventRegistration[]
  notificationSubscriptions NotificationSubscription[]

  @@index([slug])
  @@index([status])
  @@index([deletedAt])
}

// ==============================================================================
// USER MODEL
// ==============================================================================
// Users are global identities. Email is globally unique.
// Access to churches is managed via ChurchMembership.
// Platform users (Fi staff) have implicit access to all churches.
// ==============================================================================

model User {
  id           String        @id @default(cuid())
  // Globally unique email
  email        String        @unique
  passwordHash String?
  // Profile
  name         String?
  // Platform role for Fi staff (optional - most users don't have one)
  // Platform users get implicit ADMIN access to all churches
  platformRole PlatformRole?
  // Status flags
  isActive     Boolean       @default(true)
  // Timestamps
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  // Relations
  memberships         ChurchMembership[]
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  uploadedMedia       Media[]
  platformAuditLogs   PlatformAuditLog[]

  // CRM relations (for Fi staff with FI_ADMIN or SALES_REP roles)
  ownedLeads          CrmLead[]  @relation("CrmLeadOwner")
  ownedTasks          CrmTask[]  @relation("CrmTaskOwner")
  dncRecords          CrmDnc[]   @relation("CrmDncAddedBy")

  // Marketing site consultation assignments
  assignedConsultations ConsultationRequest[] @relation("ConsultationAssignee")

  // Platform media uploads (marketing site assets)
  uploadedPlatformMedia PlatformMedia[]

  // Index for efficient lookups
  @@index([email])
  @@index([platformRole])
}

// ==============================================================================
// CHURCH MEMBERSHIP MODEL
// ==============================================================================
// Links users to churches with specific roles.
// A user can have memberships in multiple churches.
// Platform users bypass this - they have implicit access to all churches.
// ==============================================================================

model ChurchMembership {
  id        String   @id @default(cuid())
  // User who has access
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Church they have access to
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  // Role within this church (Admin, Editor, Viewer)
  role      UserRole @default(VIEWER)
  // Is this the user's primary/default church?
  isPrimary Boolean  @default(false)
  // Is this membership active?
  isActive  Boolean  @default(true)
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Each user can only have one membership per church
  @@unique([userId, churchId])
  @@index([userId])
  @@index([churchId])
  @@index([userId, isActive])
}

// ==============================================================================
// SESSION MODEL
// ==============================================================================
// Database-backed sessions for secure, revocable authentication.
// Sessions are stored server-side with a token reference in a secure cookie.
// The activeChurchId can be changed without re-authentication (church switching).
// ==============================================================================

model Session {
  id        String   @id @default(cuid())
  // User who owns this session
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Currently active church context (can be switched without re-auth)
  // Null for platform-only sessions or before church is selected
  activeChurchId String?
  activeChurch   Church?  @relation(fields: [activeChurchId], references: [id], onDelete: SetNull)
  // Session token - stored in HTTP-only cookie on client
  token     String   @unique
  // Expiration - sessions are valid until this time
  expiresAt DateTime
  // Metadata for security auditing
  userAgent String?
  ipAddress String?
  // Timestamps
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([activeChurchId])
  @@index([token])
  @@index([expiresAt])
}

// ==============================================================================
// PASSWORD RESET TOKEN MODEL
// ==============================================================================
// Secure tokens for password reset flow.
// Tokens are single-use and expire after a short time (default 1 hour).
// Users are now global, so no churchId needed.
// ==============================================================================

model PasswordResetToken {
  id        String   @id @default(cuid())
  // User requesting the reset
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // The reset token - sent via email (in production)
  token     String   @unique
  // Expiration - tokens are short-lived for security
  expiresAt DateTime
  // Whether this token has been used
  usedAt    DateTime?
  // Timestamps
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
}

// ==============================================================================
// USER INVITE MODEL
// ==============================================================================
// Invitations for new users to join a church.
// Token-based invite flow: Admin creates invite → email sent → user clicks link → sets password.
// ==============================================================================

model UserInvite {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  // Invite details
  email     String
  role      UserRole
  // Secure token for the invite link
  token     String   @unique
  // Expiration - invites expire after 7 days by default
  expiresAt DateTime
  // Who sent this invite
  invitedById String?
  // Tracking
  acceptedAt DateTime?
  // Timestamps
  createdAt DateTime @default(now())

  // Email is unique per church for pending invites
  @@unique([churchId, email])
  @@index([churchId])
  @@index([token])
}

// ==============================================================================
// CONTENT MODELS
// ==============================================================================
// All content types are tenant-scoped via churchId.
// Status can be DRAFT or PUBLISHED.
// publishedAt tracks when content was first published.
// ==============================================================================

// Pages - general website pages (About, Contact, etc.)
model Page {
  id        String        @id @default(cuid())
  churchId  String
  church    Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  title     String
  // Block-based content stored as JSON array
  // Each block has: id, type, order, and type-specific data
  blocks    Json          @default("[]")
  // URL-friendly identifier for the page
  urlPath   String?
  // Optional featured image (URL string, no uploads in Phase 1)
  featuredImageUrl String?

  // Nested pages support - self-referencing relationship
  parentId  String?
  parent    Page?         @relation("PageHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  Page[]        @relation("PageHierarchy")
  // Sort order within parent (lower numbers first)
  sortOrder Int           @default(0)

  // SEO fields
  metaTitle       String?   @db.VarChar(200)
  metaDescription String?   @db.VarChar(500)
  metaKeywords    String?   @db.VarChar(500)
  ogImage         String?   // Open Graph image URL
  noIndex         Boolean   @default(false)

  // Homepage designation - only one page per church can be the homepage
  isHomePage      Boolean   @default(false)

  status      ContentStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // urlPath unique within a church
  @@unique([churchId, urlPath])
  @@index([churchId])
  @@index([status])
  @@index([parentId])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, status])
  @@index([churchId, status, createdAt])
  @@index([churchId, parentId, sortOrder])
  @@index([churchId, isHomePage])
}

// ==============================================================================
// GLOBAL BLOCKS
// ==============================================================================
// Reusable block content shared across multiple pages within a church.
// When a global block is updated, all pages referencing it reflect the change.
// ==============================================================================

model GlobalBlock {
  id          String   @id @default(cuid())
  churchId    String
  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Display name for the block library
  name        String
  // Optional description for organization
  description String?

  // The actual block content - stored same as page blocks
  // Contains: { type, data, background, advanced }
  blockContent Json

  // Soft delete support
  isActive    Boolean  @default(true)

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([churchId])
  @@index([churchId, isActive])
  @@index([churchId, name])
}

// Sermons - recorded messages/teachings
model Sermon {
  id        String        @id @default(cuid())
  churchId  String
  church    Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  title       String
  // The date the sermon was preached
  date        DateTime

  // Speaker relationship (optional for backward compatibility)
  speakerId   String?
  speaker     Speaker?      @relation(fields: [speakerId], references: [id], onDelete: SetNull)
  // Legacy/fallback field for speaker name
  speakerName String?

  // Series relationship (optional)
  seriesId    String?
  series      SermonSeries? @relation(fields: [seriesId], references: [id], onDelete: SetNull)
  // Order within the series (1, 2, 3, etc.)
  seriesOrder Int?

  // Scripture reference (legacy string field for backward compat)
  scripture   String?
  // Structured scripture references (new)
  scriptureReferences ScriptureReference[]

  // Brief description of the sermon
  description String?       @db.Text
  // Rich text sermon notes/outline
  notes       String?       @db.Text

  // Video URL (YouTube, Vimeo, etc.)
  videoUrl    String?
  // Audio URL (for podcast/MP3 version)
  audioUrl    String?
  // Sermon artwork URL
  artworkUrl  String?

  // Topic tags
  topics      SermonTopicLink[]

  status      ContentStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([churchId])
  @@index([status])
  @@index([date])
  @@index([speakerId])
  @@index([seriesId])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, status])
  @@index([churchId, status, date])
  @@index([churchId, seriesId])
  @@index([churchId, speakerId])
}

// Events - church calendar events
model Event {
  id        String        @id @default(cuid())
  churchId  String
  church    Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  title           String
  startDate       DateTime
  endDate         DateTime?

  // Venue relationship (optional - can still use location text)
  venueId         String?
  venue           Venue?    @relation(fields: [venueId], references: [id], onDelete: SetNull)
  // Keep location for backward compat or custom location text
  location        String?

  // Description as plain text for simplicity
  description     String?   @db.Text

  // External registration link (legacy - prefer built-in registration)
  registrationUrl String?

  // Featured image - can be URL or Media library reference
  featuredImageUrl String?
  featuredMediaId  String?

  // Built-in registration settings
  registrationEnabled  Boolean   @default(false)
  capacity             Int?      // null = unlimited
  waitlistEnabled      Boolean   @default(false)
  registrationDeadline DateTime?

  // Recurrence fields (display pattern only - calculate occurrences on-the-fly)
  isRecurring          Boolean   @default(false)
  recurrenceFrequency  RecurrenceFrequency?
  recurrenceInterval   Int?      // e.g., every 2 weeks
  // Days of week for weekly (bitmask: 1=Sun, 2=Mon, 4=Tue, 8=Wed, 16=Thu, 32=Fri, 64=Sat)
  recurrenceDaysOfWeek Int?
  // Day of month for monthly (1-31, -1 for last day)
  recurrenceDayOfMonth Int?
  // End conditions
  recurrenceEndDate    DateTime?
  recurrenceCount      Int?      // Max occurrences (null = until endDate)

  // Timezone for accurate recurrence calculation
  timezone             String    @default("America/New_York")

  status      ContentStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  registrations EventRegistration[]

  @@index([churchId])
  @@index([status])
  @@index([startDate])
  @@index([venueId])
  @@index([isRecurring])
  // Compound indexes for common queries
  @@index([churchId, status])
  @@index([churchId, status, startDate])
  @@index([churchId, isRecurring])
}

// ==============================================================================
// VENUE MODEL
// ==============================================================================
// Physical locations for events with capacity and address info.
// ==============================================================================

model Venue {
  id          String   @id @default(cuid())
  churchId    String
  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  name        String
  address     String?
  city        String?
  state       String?
  zipCode     String?
  // Capacity for calculating event availability
  capacity    Int?
  // Rich text notes about the venue (parking, accessibility, etc.)
  notes       String?  @db.Text
  // For ordering in dropdowns
  sortOrder   Int      @default(0)
  // Soft delete
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  events      Event[]

  @@index([churchId])
  @@index([churchId, isActive])
  @@index([sortOrder])
}

// ==============================================================================
// EVENT REGISTRATION MODEL
// ==============================================================================
// Built-in RSVP system for event attendees with waitlist and check-in support.
// ==============================================================================

model EventRegistration {
  id          String             @id @default(cuid())
  churchId    String
  church      Church             @relation(fields: [churchId], references: [id], onDelete: Cascade)

  eventId     String
  event       Event              @relation(fields: [eventId], references: [id], onDelete: Cascade)

  // For recurring events: which occurrence this registration is for
  // Stored as DateTime of the occurrence start
  occurrenceDate DateTime?

  // Registrant info (may not be a system user)
  email       String
  firstName   String
  lastName    String
  phone       String?

  // Additional attendees (for group registration)
  additionalAttendees Int       @default(0)
  // Custom fields response (JSON)
  customFields        Json?

  // Status tracking
  status      RegistrationStatus @default(REGISTERED)

  // Waitlist position (null if not waitlisted)
  waitlistPosition Int?

  // Check-in tracking
  checkedInAt  DateTime?
  checkedInBy  String?           // User ID who checked them in

  // Reminder preferences
  reminderOptIn Boolean          @default(true)

  // Token for self-service (cancel, update)
  accessToken  String            @unique @default(cuid())

  // Timestamps
  registeredAt DateTime          @default(now())
  cancelledAt  DateTime?

  // Relations
  reminders    EventReminder[]

  @@unique([eventId, email, occurrenceDate])
  @@index([churchId])
  @@index([eventId])
  @@index([eventId, status])
  @@index([email])
  @@index([accessToken])
  @@index([occurrenceDate])
  @@index([status])
}

// ==============================================================================
// EVENT REMINDER MODEL
// ==============================================================================
// Scheduled notifications for event registrants.
// ==============================================================================

model EventReminder {
  id             String             @id @default(cuid())

  registrationId String
  registration   EventRegistration  @relation(fields: [registrationId], references: [id], onDelete: Cascade)

  // When to send (calculated from event start)
  scheduledFor   DateTime
  // How to send
  channel        NotificationChannel

  // Status
  sentAt         DateTime?
  failedAt       DateTime?
  failureReason  String?

  createdAt      DateTime           @default(now())

  @@index([scheduledFor, sentAt])
  @@index([registrationId])
  @@index([scheduledFor])
}

// ==============================================================================
// NOTIFICATION SUBSCRIPTION MODEL
// ==============================================================================
// User preferences for push/SMS notifications.
// ==============================================================================

model NotificationSubscription {
  id          String   @id @default(cuid())
  churchId    String
  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Can be linked to a user or just an email
  userId      String?
  email       String?

  // Push notification subscription (Web Push API)
  // Stored as JSON: { endpoint, keys: { p256dh, auth } }
  pushSubscription Json?

  // SMS number (E.164 format)
  phoneNumber String?

  // What channels they're subscribed to
  channels    NotificationChannel[]

  // Active status
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([churchId])
  @@index([userId])
  @@index([email])
  @@index([isActive])
}

// Announcements - time-sensitive church announcements
model Announcement {
  id        String        @id @default(cuid())
  churchId  String
  church    Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  title     String
  // Body as plain text for simplicity
  body      String        @db.Text
  // When this announcement expires (null = no expiration)
  // Expired announcements are filtered at query time, not auto-deleted
  expiresAt DateTime?

  status      ContentStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([churchId])
  @@index([status])
  @@index([expiresAt])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, status])
  @@index([churchId, status, createdAt])
}

// LeadershipProfile - staff and leadership team members
model LeadershipProfile {
  id        String        @id @default(cuid())
  churchId  String
  church    Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  name      String
  // Role/title at the church (e.g., "Senior Pastor", "Worship Director")
  title     String
  bio       String?       @db.Text
  // Photo URL (no uploads in Phase 1)
  photoUrl  String?
  email     String?
  // For ordering profiles in display
  sortOrder Int           @default(0)

  status      ContentStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([churchId])
  @@index([status])
  @@index([sortOrder])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, status])
  @@index([churchId, status, sortOrder])
}

// ==============================================================================
// SERMON SERIES MODEL
// ==============================================================================
// Groups sermons into a teaching series (e.g., "The Gospel of John").
// Many-to-one relationship: each sermon can belong to one series.
// ==============================================================================

model SermonSeries {
  id          String        @id @default(cuid())
  churchId    String
  church      Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  name        String
  description String?       @db.Text
  // Artwork URL (from media library)
  artworkUrl  String?
  // Date range for the series
  startDate   DateTime?
  endDate     DateTime?
  // For ordering in listings
  sortOrder   Int           @default(0)

  status      ContentStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relations
  sermons     Sermon[]

  @@index([churchId])
  @@index([status])
  @@index([sortOrder])
  @@index([churchId, status])
  @@index([churchId, status, startDate])
}

// ==============================================================================
// SPEAKER MODEL
// ==============================================================================
// Profiles for sermon speakers (pastors, guest speakers, etc.).
// Replaces the simple string speaker field on Sermon for rich profiles.
// ==============================================================================

model Speaker {
  id        String        @id @default(cuid())
  churchId  String
  church    Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  name      String
  // Title/role (e.g., "Senior Pastor", "Guest Speaker")
  title     String?
  bio       String?       @db.Text
  // Photo URL (from media library)
  photoUrl  String?
  email     String?
  // For ordering in listings
  sortOrder Int           @default(0)
  // Flag for guest vs. regular speakers
  isGuest   Boolean       @default(false)

  // Speakers typically auto-publish
  status    ContentStatus @default(PUBLISHED)
  publishedAt DateTime?

  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  sermons   Sermon[]

  @@index([churchId])
  @@index([status])
  @@index([sortOrder])
  @@index([churchId, status])
  @@index([churchId, isGuest])
}

// ==============================================================================
// SCRIPTURE BOOK MODEL (Global Reference Data)
// ==============================================================================
// Reference table for all 66 books of the Bible.
// NOT tenant-scoped - shared across all churches.
// ==============================================================================

model ScriptureBook {
  id           String   @id @default(cuid())
  // Book name (e.g., "Genesis", "Matthew")
  name         String   @unique
  // Abbreviation (e.g., "Gen", "Matt")
  abbreviation String
  // Testament: "OT" (Old Testament) or "NT" (New Testament)
  testament    String
  // Sort order (1-66)
  sortOrder    Int      @unique
  // Number of chapters in the book
  chapterCount Int

  // Relations
  references   ScriptureReference[]

  @@index([testament])
  @@index([sortOrder])
}

// ==============================================================================
// SCRIPTURE REFERENCE MODEL
// ==============================================================================
// Structured scripture references for sermons.
// Enables filtering sermons by book/chapter.
// ==============================================================================

model ScriptureReference {
  id           String        @id @default(cuid())

  // Book reference
  bookId       String
  book         ScriptureBook @relation(fields: [bookId], references: [id])

  // Chapter/verse range
  startChapter Int
  startVerse   Int?          // null means entire chapter
  endChapter   Int?          // null means same as startChapter
  endVerse     Int?          // null means to end of chapter

  // Sermon relationship
  sermonId     String
  sermon       Sermon        @relation(fields: [sermonId], references: [id], onDelete: Cascade)

  // Display order within a sermon
  sortOrder    Int           @default(0)

  createdAt    DateTime      @default(now())

  @@index([sermonId])
  @@index([bookId])
  @@index([bookId, startChapter])
}

// ==============================================================================
// SERMON TOPIC MODEL
// ==============================================================================
// Tags/topics for categorizing sermons (e.g., "Faith", "Prayer", "Family").
// Enables filtering sermons by topic.
// ==============================================================================

model SermonTopic {
  id          String   @id @default(cuid())
  churchId    String
  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  name        String
  // URL-friendly slug
  slug        String
  description String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  sermons     SermonTopicLink[]

  // Slug must be unique within a church
  @@unique([churchId, slug])
  @@index([churchId])
  @@index([churchId, name])
}

// ==============================================================================
// SERMON TOPIC LINK (Junction Table)
// ==============================================================================
// Many-to-many relationship between Sermons and Topics.
// ==============================================================================

model SermonTopicLink {
  id        String      @id @default(cuid())
  sermonId  String
  sermon    Sermon      @relation(fields: [sermonId], references: [id], onDelete: Cascade)
  topicId   String
  topic     SermonTopic @relation(fields: [topicId], references: [id], onDelete: Cascade)

  @@unique([sermonId, topicId])
  @@index([sermonId])
  @@index([topicId])
}

// ==============================================================================
// SITE SETTINGS MODEL
// ==============================================================================
// Stores church website configuration including header, footer, service info,
// and SEO defaults. One-to-one relationship with Church.
// ==============================================================================

model SiteSettings {
  id        String @id @default(cuid())
  // Tenant reference - one settings per church
  churchId  String @unique
  church    Church @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Header settings
  logoUrl           String?
  // Navigation: JSON array of {pageId, label, order} objects
  // Stored as JSON for flexibility without a separate NavItem table
  headerNavigation  Json?   @default("[]")

  // Footer settings
  footerText        String?
  // Footer links: JSON array of {pageId, label, order} objects
  footerNavigation  Json?   @default("[]")
  // Social links (simple URL strings)
  facebookUrl       String?
  instagramUrl      String?
  youtubeUrl        String?

  // Service info (displayed on home and/or contact page)
  serviceTimes      String? @db.Text
  address           String?
  phone             String?
  contactEmail      String?

  // SEO defaults
  metaTitle         String?
  metaDescription   String?
  faviconUrl        String?

  // Google Maps embed URL (optional, for contact page)
  mapEmbedUrl       String?

  // Home page configuration
  // If set, this page ID is used as the home page; otherwise default welcome
  homePageId        String?

  // Phase 3: Notification recipients (comma-separated emails)
  // If null, falls back to contactEmail
  prayerNotifyEmails    String?
  volunteerNotifyEmails String?

  // Phase 4: Maintenance mode
  // When true, public site shows "Site is being prepared" message
  // Dashboard remains accessible
  maintenanceMode       Boolean @default(false)

  // Template Settings
  // Header template: "classic", "centered", "minimal", "split"
  headerTemplate        String  @default("classic")
  // Header configuration as JSON (see types/template.ts for structure)
  headerConfig          Json?
  // Footer template: "4-column", "3-column", "2-column", "stacked", "minimal"
  footerTemplate        String  @default("4-column")
  // Footer configuration as JSON (see types/template.ts for structure)
  footerConfig          Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==============================================================================
// CHURCH BRANDING MODEL
// ==============================================================================
// Branding configuration for the public church website.
// Stores logos, colors, gradients, fonts, and typography settings.
// ==============================================================================

model ChurchBranding {
  id        String @id @default(cuid())
  // Tenant reference - one branding config per church
  churchId  String @unique
  church    Church @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // LOGOS
  // Main header logo (displayed on light backgrounds)
  logoHeaderUrl     String?
  // Light version of logo (for dark backgrounds)
  logoLightUrl      String?
  // Dark version of logo (for light backgrounds)
  logoDarkUrl       String?
  // Favicon (32x32 or 16x16 PNG/ICO)
  faviconUrl        String?

  // COLOR PALETTE
  // Primary brand color (e.g., #1e40af)
  colorPrimary      String?
  // Secondary brand color
  colorSecondary    String?
  // Accent color (for highlights, buttons)
  colorAccent       String?
  // Background color for light mode
  colorBackground   String?
  // Text color for body copy
  colorText         String?
  // Custom color presets: JSON array of {name, value} objects
  // e.g., [{"name": "Navy", "value": "#1e3a5f"}, ...]
  colorPresets      Json?   @default("[]")

  // GRADIENT PRESETS
  // JSON array of {name, value} objects
  // e.g., [{"name": "Ocean", "value": "linear-gradient(135deg, #667eea 0%, #764ba2 100%)"}, ...]
  gradientPresets   Json?   @default("[]")

  // TYPOGRAPHY
  // Primary font for headings (Google Fonts name or system font)
  fontPrimary       String?
  // Secondary font for body text
  fontSecondary     String?
  // Base font size in pixels (typically 16)
  fontSizeBase      Int?    @default(16)
  // Heading scale factor (e.g., 1.25 for modular scale)
  headingScale      Float?  @default(1.25)
  // Line height for body text (e.g., 1.5)
  lineHeight        Float?  @default(1.5)

  // BUTTON STYLES
  // Border radius for buttons (e.g., "rounded", "pill", "square")
  buttonStyle       String? @default("rounded")
  // Default button border radius in pixels
  buttonRadius      Int?    @default(6)
  // Button colors (defaults to brand colors if not set)
  buttonPrimaryBg      String?  // Primary button background
  buttonPrimaryText    String?  // Primary button text color
  buttonSecondaryBg    String?  // Secondary button background
  buttonSecondaryText  String?  // Secondary button text color
  buttonOutlineBorder  String?  // Outline button border color
  buttonOutlineText    String?  // Outline button text color
  buttonAccentBg       String?  // Accent button background
  buttonAccentText     String?  // Accent button text color

  // SPACING
  // Global spacing density ("compact" | "comfortable" | "spacious")
  spacingDensity    String? @default("comfortable")
  // Global content width ("narrow" | "normal" | "wide")
  contentWidth      String? @default("normal")

  // ADDITIONAL STYLES
  // Global border radius preference in pixels
  borderRadius      Int?    @default(8)
  // Link color (defaults to primary if not set)
  linkColor         String?
  // Link hover color
  linkHoverColor    String?

  // LIGHT THEME COLORS (for text on dark backgrounds)
  // These define the text colors used when textTheme="light" is selected
  // Heading color for light theme (default: #ffffff)
  lightHeadingColor   String?
  // Body text color for light theme (default: rgba(255,255,255,0.9))
  lightTextColor      String?
  // Subtext/muted color for light theme (default: rgba(255,255,255,0.7))
  lightSubtextColor   String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([churchId])
}

// ==============================================================================
// CONTACT SUBMISSION MODEL
// ==============================================================================
// Stores contact form submissions from the public website.
// Tenant-scoped for isolation.
// ==============================================================================

model ContactSubmission {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Form fields
  name      String
  email     String
  message   String   @db.Text

  // Metadata for spam tracking
  ipAddress String?
  userAgent String?

  // Status tracking
  isRead    Boolean  @default(false)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([churchId])
  @@index([createdAt])
  @@index([isRead])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, isRead])
  @@index([churchId, createdAt])
}

// ==============================================================================
// PHASE 3: MEDIA LIBRARY
// ==============================================================================
// Tenant-scoped media storage for images and PDFs.
// Supports multiple sizes for images (original + resized versions).
// ==============================================================================

model Media {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Upload tracking
  uploadedById String
  uploadedBy   User   @relation(fields: [uploadedById], references: [id], onDelete: SetNull)

  // File metadata
  filename     String   // Original filename for display
  mimeType     String   // e.g., "image/jpeg", "application/pdf"
  size         Int      // File size in bytes

  // Storage paths (relative to storage root)
  // For images: stores path to original
  storagePath  String
  // For images: JSON with resized versions { "small": "path", "medium": "path" }
  // For PDFs: null
  variants     Json?

  // Display info
  alt          String?  // Alt text for images

  // Soft delete support
  deletedAt    DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([churchId])
  @@index([uploadedById])
  @@index([mimeType])
  @@index([deletedAt])
  @@index([createdAt])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, deletedAt])
  @@index([churchId, mimeType, deletedAt])
  @@index([churchId, createdAt])
}

// ==============================================================================
// PHASE 3: PRAYER REQUEST FORM
// ==============================================================================
// Private prayer request submissions from the public website.
// Only visible to Admin/Editor in dashboard.
// ==============================================================================

model PrayerRequest {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Form fields (name/email optional for anonymous requests)
  name      String?
  email     String?
  request   String   @db.Text

  // Metadata for spam tracking
  ipAddress String?
  userAgent String?

  // Status tracking
  isRead      Boolean   @default(false)
  isArchived  Boolean   @default(false)
  archivedAt  DateTime?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([churchId])
  @@index([createdAt])
  @@index([isRead])
  @@index([isArchived])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, isRead])
  @@index([churchId, isArchived])
  @@index([churchId, createdAt])
}

// ==============================================================================
// PHASE 3: VOLUNTEER SIGNUP FORM
// ==============================================================================
// Volunteer signup submissions from the public website.
// Visible to Admin/Editor in dashboard.
// ==============================================================================

model VolunteerSignup {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Form fields
  name      String
  email     String
  phone     String?
  // Areas of interest as JSON array of strings
  // Allows flexibility without a separate table
  interests Json?    @default("[]")
  message   String?  @db.Text

  // Metadata for spam tracking
  ipAddress String?
  userAgent String?

  // Status tracking
  isRead      Boolean   @default(false)
  isArchived  Boolean   @default(false)
  archivedAt  DateTime?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([churchId])
  @@index([createdAt])
  @@index([isRead])
  @@index([isArchived])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, isRead])
  @@index([churchId, isArchived])
  @@index([churchId, createdAt])
}

// ==============================================================================
// PHASE 4: CUSTOM DOMAINS
// ==============================================================================
// Team-managed custom domain support for church websites.
// DNS TXT record verification for domain ownership.
// ==============================================================================

// Domain verification status
enum DomainStatus {
  PENDING   // Awaiting DNS verification
  ACTIVE    // Verified and active
  ERROR     // Verification failed or domain issue
}

model CustomDomain {
  id        String       @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Domain hostname (normalized, lowercase, no trailing dot)
  // e.g., "www.gracechurch.org" or "gracechurch.org"
  hostname  String       @unique

  // Verification status
  status    DomainStatus @default(PENDING)
  // When the domain was verified
  verifiedAt DateTime?
  // Token for DNS TXT record verification
  // Format: fi-verify=<token>
  verificationToken String

  // Admin notes (e.g., "Primary domain", "Redirect to www")
  notes     String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([churchId])
  @@index([hostname])
  @@index([status])
}

// ==============================================================================
// PHASE 4: REDIRECT RULES
// ==============================================================================
// Tenant-scoped 301 permanent redirects for URL management.
// Applied to public routes after tenant resolution.
// ==============================================================================

model RedirectRule {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Source path (relative, starts with /)
  // e.g., "/old-page", "/events/2023"
  sourcePath      String

  // Destination URL (absolute URL or relative path)
  // e.g., "/new-page", "https://external.com/page"
  destinationUrl  String

  // Whether this rule is active
  isActive  Boolean  @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Source path must be unique per church
  @@unique([churchId, sourcePath])
  @@index([churchId])
  @@index([isActive])
  // Phase 5: Compound indexes for redirect lookup
  @@index([churchId, isActive, sourcePath])
}

// ==============================================================================
// PHASE 4: LAUNCH CHECKLIST
// ==============================================================================
// Structured checklist for site launch preparation.
// Tracks completion status of key launch tasks.
// ==============================================================================

model LaunchChecklistItem {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Item key identifier (e.g., "domain_added", "ssl_active")
  // Predefined keys ensure consistent checklist across churches
  itemKey   String

  // Completion status
  isComplete  Boolean   @default(false)
  completedAt DateTime?
  completedBy String?   // User ID who completed the item

  // Optional notes
  notes     String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Each item key is unique per church
  @@unique([churchId, itemKey])
  @@index([churchId])
}

// ==============================================================================
// PHASE 5: AUDIT LOG
// ==============================================================================
// Tracks sensitive admin actions for security and compliance.
// Immutable log - entries cannot be modified or deleted.
// ==============================================================================

// Audit action types
enum AuditAction {
  // User management
  USER_INVITED
  USER_ROLE_CHANGED
  USER_DEACTIVATED
  USER_REACTIVATED
  // Content lifecycle
  CONTENT_PUBLISHED
  CONTENT_UNPUBLISHED
  CONTENT_DELETED
  // Domain management
  DOMAIN_ADDED
  DOMAIN_VERIFIED
  DOMAIN_REMOVED
  // Redirect management
  REDIRECT_CREATED
  REDIRECT_UPDATED
  REDIRECT_DELETED
  // Site settings
  SETTINGS_UPDATED
  MAINTENANCE_MODE_ENABLED
  MAINTENANCE_MODE_DISABLED
  // Authentication events
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
  // Event registration
  EVENT_REGISTRATION_CREATED
  EVENT_REGISTRATION_CANCELLED
  EVENT_REGISTRATION_CHECKED_IN
  EVENT_REGISTRATIONS_EXPORTED
  // Venue management
  VENUE_CREATED
  VENUE_UPDATED
  VENUE_DELETED
}

// Entity types for audit logging
enum AuditEntityType {
  USER
  USER_INVITE
  PAGE
  SERMON
  SERMON_SERIES
  SPEAKER
  SERMON_TOPIC
  EVENT
  ANNOUNCEMENT
  LEADERSHIP_PROFILE
  CUSTOM_DOMAIN
  REDIRECT_RULE
  SITE_SETTINGS
  SESSION
  VENUE
  EVENT_REGISTRATION
}

model AuditLog {
  id          String          @id @default(cuid())
  // Tenant reference
  churchId    String

  // Who performed the action (null for system actions or failed logins)
  actorUserId String?
  actorEmail  String?         // Captured at time of action for historical record
  actorIp     String?         // IP address at time of action

  // What action was performed
  action      AuditAction

  // What entity was affected
  entityType  AuditEntityType
  entityId    String?         // ID of affected entity (null for some actions)

  // Additional context (JSON)
  // e.g., { "oldRole": "VIEWER", "newRole": "EDITOR" }
  metadata    Json?

  // Request context
  requestId   String?         // Correlation ID for request tracing
  userAgent   String?

  // Timestamp (immutable)
  createdAt   DateTime        @default(now())

  // Compound indexes for efficient querying
  @@index([churchId, createdAt])
  @@index([churchId, action])
  @@index([churchId, entityType])
  @@index([churchId, actorUserId])
  @@index([actorUserId])
  @@index([createdAt])
}

// ==============================================================================
// PHASE 5: LOGIN ATTEMPTS (Account Lockout)
// ==============================================================================
// Tracks failed login attempts for account lockout protection.
// Now global since users are global identities.
// ==============================================================================

model LoginAttempt {
  id        String   @id @default(cuid())
  // Email attempted (normalized lowercase)
  email     String
  // IP address of attempt
  ipAddress String
  // Whether the attempt succeeded
  success   Boolean
  // Reason for failure (if applicable)
  failReason String?
  // Timestamp
  createdAt DateTime @default(now())

  // Indexes for lockout queries
  @@index([email, createdAt])
  @@index([ipAddress, createdAt])
  @@index([createdAt])
}

// ==============================================================================
// SUPER ADMIN: MARKETING WEBSITE
// ==============================================================================
// Global (non-tenant-scoped) content for the Fi marketing website.
// Managed exclusively by platform_admin/platform_staff users.
// ==============================================================================

// Marketing page status
enum MarketingPageStatus {
  DRAFT
  PUBLISHED
}

model MarketingPage {
  id        String              @id @default(cuid())

  // Page content
  title     String
  // URL slug (unique, global) e.g., "pricing", "about", "contact"
  slug      String              @unique
  // Block-based content stored as JSON array
  // Each block has: id, type, order, and type-specific data
  blocks    Json                @default("[]")

  // Nested pages support - self-referencing relationship
  parentId  String?
  parent    MarketingPage?      @relation("MarketingPageHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  MarketingPage[]     @relation("MarketingPageHierarchy")
  // Sort order within parent (lower numbers first)
  sortOrder Int                 @default(0)

  // Publication status
  status    MarketingPageStatus @default(DRAFT)
  publishedAt DateTime?

  // SEO fields
  metaTitle       String?   @db.VarChar(200)
  metaDescription String?   @db.VarChar(500)
  metaKeywords    String?   @db.VarChar(500)
  ogImage         String?   // Open Graph image URL
  noIndex         Boolean   @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([parentId])
  @@index([parentId, sortOrder])
}

model MarketingSiteSettings {
  id        String @id @default(cuid())

  // Site identity
  siteName          String   @default("Faith Interactive")
  defaultMetaTitle  String?
  defaultMetaDescription String?
  faviconUrl        String?

  // Header navigation: JSON array of { label, url, order }
  // url can be internal slug ("/pricing") or external ("https://...")
  headerNavigation  Json     @default("[]")

  // Footer content
  footerText        String?
  // Footer links: JSON array of { label, url, order }
  footerLinks       Json     @default("[]")

  // Home page slug (which marketing page is the home)
  homePageSlug      String   @default("home")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==============================================================================
// MARKETING BLOG SYSTEM
// ==============================================================================
// Blog posts for the Fi marketing website ("Trends" section).
// Supports categories, tags, and block-based content.
// ==============================================================================

model BlogCategory {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  sortOrder   Int        @default(0)

  posts       BlogPost[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([slug])
  @@index([sortOrder])
}

model BlogTag {
  id    String        @id @default(cuid())
  name  String
  slug  String        @unique

  posts BlogPostTag[]

  createdAt DateTime @default(now())

  @@index([slug])
}

model BlogPost {
  id              String              @id @default(cuid())
  title           String
  slug            String              @unique
  excerpt         String?             @db.VarChar(500)
  // Block-based content (same structure as MarketingPage)
  blocks          Json                @default("[]")
  featuredImage   String?

  // Category relationship
  categoryId      String?
  category        BlogCategory?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Author info (cached for display)
  authorId        String?
  authorName      String?

  // Publication
  status          MarketingPageStatus @default(DRAFT)
  publishedAt     DateTime?

  // SEO fields
  metaTitle       String?             @db.VarChar(200)
  metaDescription String?             @db.VarChar(500)
  ogImage         String?
  noIndex         Boolean             @default(false)

  // Relations
  tags            BlogPostTag[]

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([slug])
  @@index([status])
  @@index([categoryId])
  @@index([publishedAt])
  @@index([status, publishedAt])
}

// Junction table for BlogPost <-> BlogTag many-to-many
model BlogPostTag {
  id       String   @id @default(cuid())
  postId   String
  post     BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tagId    String
  tag      BlogTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

// ==============================================================================
// MARKETING CASE STUDIES
// ==============================================================================
// Showcase of church websites built by Faith Interactive.
// Includes before/after images, testimonials, and metrics.
// ==============================================================================

model CaseStudy {
  id               String              @id @default(cuid())
  churchName       String
  slug             String              @unique
  logo             String?
  description      String              @db.Text
  // Challenge faced by the client
  challenge        String?             @db.Text
  // Solution provided by Faith Interactive
  solution         String?             @db.Text
  // Gallery images as JSON array of URLs
  images           Json                @default("[]")
  // Before/after comparison images
  beforeImage      String?
  afterImage       String?
  // Client testimonial
  testimonialQuote String?             @db.Text
  testimonialName  String?
  testimonialTitle String?
  // Metrics as JSON: { "traffic": "+200%", "conversions": "3x", etc. }
  metrics          Json?
  // Link to live site
  liveSiteUrl      String?
  // Display options
  featured         Boolean             @default(false)
  sortOrder        Int                 @default(0)

  status           MarketingPageStatus @default(DRAFT)
  publishedAt      DateTime?

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([slug])
  @@index([status])
  @@index([featured])
  @@index([sortOrder])
  @@index([status, featured])
}

// ==============================================================================
// MARKETING TESTIMONIALS
// ==============================================================================
// General testimonials for display across the marketing site.
// Can be featured on homepage, case studies page, etc.
// ==============================================================================

model Testimonial {
  id          String   @id @default(cuid())
  name        String
  title       String?  // e.g., "Senior Pastor"
  company     String?  // e.g., "Grace Community Church"
  quote       String   @db.Text
  image       String?
  featured    Boolean  @default(false)
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([featured])
  @@index([isActive])
  @@index([sortOrder])
  @@index([isActive, featured])
  @@index([isActive, sortOrder])
}

// ==============================================================================
// PLATFORM MEDIA
// ==============================================================================
// Media files for the marketing site (case studies, blog posts, etc.)
// Not tenant-scoped - managed by platform admins only.
// ==============================================================================

model PlatformMedia {
  id           String   @id @default(cuid())

  // Upload tracking
  uploadedById String
  uploadedBy   User     @relation(fields: [uploadedById], references: [id], onDelete: SetNull)

  // File metadata
  filename     String   // Original filename for display
  mimeType     String   // e.g., "image/jpeg", "application/pdf"
  size         Int      // File size in bytes

  // Storage paths (relative to storage root)
  storagePath  String
  // For images: JSON with resized versions { "small": "path", "medium": "path" }
  variants     Json?

  // Display info
  alt          String?  // Alt text for images

  // Soft delete support
  deletedAt    DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([mimeType])
  @@index([deletedAt])
  @@index([createdAt])
}

// ==============================================================================
// CONSULTATION REQUESTS
// ==============================================================================
// Lead capture from the marketing website contact form.
// Saved to database and emailed to platform admins.
// ==============================================================================

// Consultation request status
enum ConsultationStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  CLOSED
}

model ConsultationRequest {
  id              String             @id @default(cuid())

  // Contact info
  name            String
  email           String
  phone           String?
  churchName      String?

  // Interest
  packageInterest String?            // "free", "small", "large"
  message         String?            @db.Text

  // Tracking
  status          ConsultationStatus @default(NEW)
  notes           String?            @db.Text

  // Spam protection metadata
  ipAddress       String?
  userAgent       String?

  // Assignment (to platform user/sales rep)
  assignedToId    String?
  assignedTo      User?              @relation("ConsultationAssignee", fields: [assignedToId], references: [id], onDelete: SetNull)

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([assignedToId])
  @@index([status, createdAt])
}

// ==============================================================================
// SUPER ADMIN: PLATFORM AUDIT LOG
// ==============================================================================
// Tracks sensitive platform-level admin actions.
// Separate from tenant-scoped AuditLog to keep them isolated.
// ==============================================================================

// Platform audit action types
enum PlatformAuditAction {
  // Church management
  CHURCH_CREATED
  CHURCH_UPDATED
  CHURCH_SUSPENDED
  CHURCH_UNSUSPENDED
  CHURCH_DELETED
  // Church user management (from super admin)
  CHURCH_USER_INVITED
  CHURCH_USER_ROLE_CHANGED
  CHURCH_USER_DEACTIVATED
  // Domain management (from super admin)
  CHURCH_DOMAIN_ADDED
  CHURCH_DOMAIN_VERIFIED
  CHURCH_DOMAIN_REMOVED
  // Marketing site
  MARKETING_PAGE_CREATED
  MARKETING_PAGE_UPDATED
  MARKETING_PAGE_PUBLISHED
  MARKETING_PAGE_UNPUBLISHED
  MARKETING_PAGE_DELETED
  MARKETING_SETTINGS_UPDATED
  // Impersonation
  IMPERSONATION_STARTED
  IMPERSONATION_ENDED
}

// Platform entity types
enum PlatformEntityType {
  CHURCH
  CHURCH_USER
  CHURCH_DOMAIN
  MARKETING_PAGE
  MARKETING_SETTINGS
  SESSION
}

model PlatformAuditLog {
  id          String               @id @default(cuid())

  // Who performed the action (platform user)
  actorUserId String
  actor       User                 @relation(fields: [actorUserId], references: [id], onDelete: SetNull)
  actorEmail  String               // Captured at time of action
  actorIp     String?

  // What action was performed
  action      PlatformAuditAction

  // What entity was affected
  entityType  PlatformEntityType
  entityId    String?              // ID of affected entity

  // For church-related actions, which church was affected
  targetChurchId String?

  // Additional context (JSON)
  metadata    Json?

  // Request context
  requestId   String?
  userAgent   String?

  // Timestamp (immutable)
  createdAt   DateTime             @default(now())

  // Indexes for efficient querying
  @@index([actorUserId])
  @@index([action])
  @@index([entityType])
  @@index([targetChurchId])
  @@index([createdAt])
}

// ==============================================================================
// CONFIGURABLE FORMS SYSTEM
// ==============================================================================
// Unified form system with configurable fields, submissions management,
// and spam protection. Replaces individual form tables while maintaining
// backward compatibility through the FormType enum.
// ==============================================================================

model Form {
  id          String   @id @default(cuid())
  // Tenant reference
  churchId    String
  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Form identity
  name        String              // Internal name for admins (e.g., "Contact Form")
  slug        String              // URL-friendly identifier (e.g., "contact")
  description String?             // Optional description shown above form

  // Form type - determines default fields and behavior
  type        FormType @default(CUSTOM)

  // Field definitions as JSON array
  // Each field: { id, type, name, label, placeholder?, helpText?, required, order, validation?, options?, fileConfig? }
  fields      Json     @default("[]")

  // Form settings as JSON
  // { successMessage, submitButtonText, honeypotEnabled, honeypotFieldName, minSubmitTime }
  settings    Json     @default("{}")

  // Notification recipients (array of email addresses)
  notifyEmails String[] @default([])

  // Whether the form is active and accepting submissions
  isActive    Boolean  @default(true)

  // Relations
  submissions FormSubmission[]

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Slug must be unique within a church
  @@unique([churchId, slug])
  @@index([churchId])
  @@index([churchId, type])
  @@index([churchId, isActive])
}

model FormSubmission {
  id          String   @id @default(cuid())
  // Tenant reference
  churchId    String
  church      Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Form reference
  formId      String
  form        Form     @relation(fields: [formId], references: [id], onDelete: Cascade)

  // Submitted data as JSON object
  // Keys match field names, values are the submitted data
  data        Json

  // File references as JSON array (if form has file upload fields)
  // Each: { fieldName, fileId, filename, storedPath, mimeType, size }
  files       Json?

  // Spam tracking metadata
  ipAddress   String?
  userAgent   String?

  // Submission timestamp
  submittedAt DateTime @default(now())

  // Status tracking
  isRead      Boolean  @default(false)
  readAt      DateTime?
  readBy      String?             // User ID who marked as read

  // Timestamps
  createdAt   DateTime @default(now())

  @@index([churchId])
  @@index([formId])
  @@index([formId, isRead])
  @@index([formId, createdAt])
  @@index([churchId, createdAt])
}

model FormFile {
  id           String   @id @default(cuid())
  // Tenant reference
  churchId     String
  church       Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Linked to submission after form is submitted
  // Null while file is in temporary storage (before submission completes)
  submissionId String?

  // File metadata
  filename     String              // Original filename
  storedPath   String              // Path in storage (relative to uploads root)
  mimeType     String              // MIME type (e.g., "image/jpeg", "application/pdf")
  size         Int                 // File size in bytes

  // Upload timestamp
  uploadedAt   DateTime @default(now())

  // Expiration for orphaned files (not linked to submission)
  // Cleanup job removes files where submissionId is null and uploadedAt > 24 hours
  expiresAt    DateTime?

  @@index([churchId])
  @@index([submissionId])
  @@index([expiresAt])
}

// ==============================================================================
// CRM SYSTEM (Fi Internal Sales)
// ==============================================================================
// Internal CRM for Fi staff to manage church/prospect leads.
// NOT tenant-scoped - this is a global Fi staff tool.
// Access controlled by PlatformRole: FI_ADMIN and SALES_REP only.
// ==============================================================================

// CRM task types
enum CrmTaskType {
  CALL
  EMAIL
  TEXT
  MEETING
  INSTAGRAM
  FACEBOOK
  TIKTOK
  TWITTER
  OTHER
}

// CRM task status
enum CrmTaskStatus {
  OPEN
  DONE
}

// ==============================================================================
// CRM STAGE
// ==============================================================================
// Sales pipeline stages for organizing leads.
// ==============================================================================

model CrmStage {
  id        String   @id @default(cuid())
  name      String
  sortOrder Int      @default(0)
  isActive  Boolean  @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  leads     CrmLead[]

  @@index([sortOrder])
  @@index([isActive])
  @@index([isActive, sortOrder])
}

// ==============================================================================
// CRM LEAD
// ==============================================================================
// Church/prospect leads managed by Fi sales team.
// ==============================================================================

model CrmLead {
  id                 String    @id @default(cuid())

  // Church/prospect info
  churchName         String
  primaryContactName String?
  email              String?
  phone              String?
  website            String?
  location           String?   // City/State

  // Pipeline
  stageId            String
  stage              CrmStage  @relation(fields: [stageId], references: [id])

  // Ownership (optional for unassigned leads)
  ownerUserId        String?
  owner              User?     @relation("CrmLeadOwner", fields: [ownerUserId], references: [id])

  // Lead source
  source             String?   // referral, inbound, list, event, etc.

  // Notes
  notes              String?   @db.Text

  // Derived: earliest open task due date (updated by triggers/actions)
  nextFollowUpAt     DateTime?

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Relations
  tasks              CrmTask[]
  dnc                CrmDnc?

  @@index([stageId])
  @@index([ownerUserId])
  @@index([nextFollowUpAt])
  @@index([ownerUserId, stageId])
  @@index([ownerUserId, nextFollowUpAt])
  @@index([createdAt])
}

// ==============================================================================
// CRM TASK
// ==============================================================================
// Follow-up tasks for leads (calls, emails, meetings, etc.).
// ==============================================================================

model CrmTask {
  id          String        @id @default(cuid())

  // Lead reference
  leadId      String
  lead        CrmLead       @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Task owner (can be different from lead owner in future)
  ownerUserId String
  owner       User          @relation("CrmTaskOwner", fields: [ownerUserId], references: [id])

  // Task details
  type        CrmTaskType
  dueAt       DateTime
  status      CrmTaskStatus @default(OPEN)
  notes       String?       @db.Text

  // Completion tracking
  completedAt DateTime?

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([leadId])
  @@index([ownerUserId])
  @@index([status])
  @@index([dueAt])
  @@index([ownerUserId, status])
  @@index([ownerUserId, status, dueAt])
  @@index([leadId, status])
}

// ==============================================================================
// CRM DNC (Do Not Contact)
// ==============================================================================
// Flags leads that should not be contacted.
// One DNC record per lead for v1.
// ==============================================================================

model CrmDnc {
  id            String   @id @default(cuid())

  // One DNC per lead
  leadId        String   @unique
  lead          CrmLead  @relation(fields: [leadId], references: [id], onDelete: Cascade)

  // Reason for DNC status
  reason        String?

  // Who marked it as DNC
  addedByUserId String
  addedBy       User     @relation("CrmDncAddedBy", fields: [addedByUserId], references: [id])

  // When it was marked
  addedAt       DateTime @default(now())

  @@index([addedByUserId])
}
