// ==============================================================================
// Faith Interactive - Marketing Site Schema
// ==============================================================================
// Simplified schema for marketing-only website.
// No multi-tenant/church functionality.
// ==============================================================================

generator client {
  provider   = "prisma-client-js"
  // Use client-side engine for Cloudflare Workers compatibility (no Rust binaries)
  engineType = "client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================================================
// MARKETING SITE SETTINGS
// ==============================================================================

model MarketingSiteSettings {
  id        String @id @default(cuid())

  // Site identity
  siteName          String   @default("Faith Interactive")
  defaultMetaTitle  String?
  defaultMetaDescription String?
  faviconUrl        String?

  // Header navigation: JSON array of { label, url, order }
  headerNavigation  Json     @default("[]")

  // Footer content
  footerText        String?
  footerLinks       Json     @default("[]")

  // Home page slug
  homePageSlug      String   @default("home")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==============================================================================
// MARKETING PAGES
// ==============================================================================

enum MarketingPageStatus {
  DRAFT
  PUBLISHED
}

model MarketingPage {
  id        String              @id @default(cuid())

  title     String
  slug      String              @unique
  blocks    Json                @default("[]")

  // Nested pages support
  parentId  String?
  parent    MarketingPage?      @relation("MarketingPageHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children  MarketingPage[]     @relation("MarketingPageHierarchy")
  sortOrder Int                 @default(0)

  status    MarketingPageStatus @default(DRAFT)
  publishedAt DateTime?

  // SEO fields
  metaTitle       String?   @db.VarChar(200)
  metaDescription String?   @db.VarChar(500)
  metaKeywords    String?   @db.VarChar(500)
  ogImage         String?
  noIndex         Boolean   @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([slug])
  @@index([status])
  @@index([parentId])
  @@index([parentId, sortOrder])
}

// ==============================================================================
// BLOG SYSTEM
// ==============================================================================

model BlogCategory {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  sortOrder   Int        @default(0)

  posts       BlogPost[]

  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([slug])
  @@index([sortOrder])
}

model BlogTag {
  id    String        @id @default(cuid())
  name  String
  slug  String        @unique

  posts BlogPostTag[]

  createdAt DateTime @default(now())

  @@index([slug])
}

model BlogPost {
  id              String              @id @default(cuid())
  title           String
  slug            String              @unique
  excerpt         String?             @db.VarChar(500)
  blocks          Json                @default("[]")
  featuredImage   String?

  categoryId      String?
  category        BlogCategory?       @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  authorName      String?

  status          MarketingPageStatus @default(DRAFT)
  publishedAt     DateTime?

  // SEO fields
  metaTitle       String?             @db.VarChar(200)
  metaDescription String?             @db.VarChar(500)
  ogImage         String?
  noIndex         Boolean             @default(false)

  tags            BlogPostTag[]

  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([slug])
  @@index([status])
  @@index([categoryId])
  @@index([publishedAt])
  @@index([status, publishedAt])
}

model BlogPostTag {
  id       String   @id @default(cuid())
  postId   String
  post     BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tagId    String
  tag      BlogTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

// ==============================================================================
// CASE STUDIES
// ==============================================================================

model CaseStudy {
  id               String              @id @default(cuid())
  churchName       String
  slug             String              @unique
  logo             String?
  description      String              @db.Text
  challenge        String?             @db.Text
  solution         String?             @db.Text
  images           Json                @default("[]")
  beforeImage      String?
  afterImage       String?
  testimonialQuote String?             @db.Text
  testimonialName  String?
  testimonialTitle String?
  metrics          Json?
  liveSiteUrl      String?
  featured         Boolean             @default(false)
  sortOrder        Int                 @default(0)

  status           MarketingPageStatus @default(DRAFT)
  publishedAt      DateTime?

  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  @@index([slug])
  @@index([status])
  @@index([featured])
  @@index([sortOrder])
  @@index([status, featured])
}

// ==============================================================================
// TESTIMONIALS
// ==============================================================================

model Testimonial {
  id          String   @id @default(cuid())
  name        String
  title       String?
  company     String?
  quote       String   @db.Text
  image       String?
  featured    Boolean  @default(false)
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([featured])
  @@index([isActive])
  @@index([sortOrder])
  @@index([isActive, featured])
  @@index([isActive, sortOrder])
}

// ==============================================================================
// PLATFORM MEDIA
// ==============================================================================

model PlatformMedia {
  id           String   @id @default(cuid())

  filename     String
  mimeType     String
  size         Int

  storagePath  String
  variants     Json?

  alt          String?

  deletedAt    DateTime?

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([mimeType])
  @@index([deletedAt])
  @@index([createdAt])
}

// ==============================================================================
// CONSULTATION REQUESTS (Lead Capture)
// ==============================================================================

enum ConsultationStatus {
  NEW
  CONTACTED
  QUALIFIED
  CONVERTED
  CLOSED
}

model ConsultationRequest {
  id              String             @id @default(cuid())

  name            String
  email           String
  phone           String?
  churchName      String?

  packageInterest String?
  message         String?            @db.Text

  status          ConsultationStatus @default(NEW)
  notes           String?            @db.Text

  ipAddress       String?
  userAgent       String?

  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([status, createdAt])
}
