// ==============================================================================
// Faith Interactive - Prisma Schema
// ==============================================================================
// Multi-tenant data model for a church SaaS platform.
// Every table (except Church) has a churchId foreign key for tenant isolation.
// ==============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==============================================================================
// ENUMS
// ==============================================================================

// User roles for access control
// Admin: full access including user management
// Editor: can create/edit/publish content, no user management
// Viewer: read-only dashboard access
enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

// Content publication status
enum ContentStatus {
  DRAFT
  PUBLISHED
}

// ==============================================================================
// TENANT MODEL
// ==============================================================================
// The Church model represents a tenant in the multi-tenant system.
// Each church has its own isolated data set.
// ==============================================================================

model Church {
  id        String   @id @default(cuid())
  // Subdomain slug - used to identify the tenant from the URL
  // e.g., "grace-community" for grace-community.faithinteractive.com
  slug      String   @unique
  // Display name of the church
  name      String
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - all tenant-scoped data
  users               User[]
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  userInvites         UserInvite[]

  // Content types
  pages               Page[]
  sermons             Sermon[]
  events              Event[]
  announcements       Announcement[]
  leadershipProfiles  LeadershipProfile[]

  // Site configuration
  siteSettings        SiteSettings?
  contactSubmissions  ContactSubmission[]

  // Phase 3: Media + Forms
  media               Media[]
  prayerRequests      PrayerRequest[]
  volunteerSignups    VolunteerSignup[]

  // Phase 4: Domains & Launch Tools
  customDomains       CustomDomain[]
  redirectRules       RedirectRule[]
  launchChecklist     LaunchChecklistItem[]

  @@index([slug])
}

// ==============================================================================
// USER MODEL
// ==============================================================================
// Users belong to exactly one church (tenant).
// Email uniqueness is scoped to the church - the same email can exist
// in different churches.
// ==============================================================================

model User {
  id           String   @id @default(cuid())
  // Tenant reference - REQUIRED for all operations
  churchId     String
  church       Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  // User credentials
  email        String
  passwordHash String?
  // Profile
  name         String?
  // Role determines permissions (Admin, Editor, Viewer)
  role         UserRole @default(VIEWER)
  // Status flags
  isActive     Boolean  @default(true)
  // Timestamps
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  sessions            Session[]
  passwordResetTokens PasswordResetToken[]
  uploadedMedia       Media[]

  // Email is unique within a church, not globally
  // This allows the same email to be used across different tenants
  @@unique([churchId, email])
  // Index for efficient lookups
  @@index([churchId])
  @@index([email])
}

// ==============================================================================
// SESSION MODEL
// ==============================================================================
// Database-backed sessions for secure, revocable authentication.
// Sessions are stored server-side with a token reference in a secure cookie.
// This approach is more secure than JWT-only because:
// - Sessions can be revoked immediately
// - No token refresh complexity
// - Session data isn't exposed to the client
// ==============================================================================

model Session {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  // User who owns this session
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Session token - stored in HTTP-only cookie on client
  token     String   @unique
  // Expiration - sessions are valid until this time
  expiresAt DateTime
  // Metadata for security auditing
  userAgent String?
  ipAddress String?
  // Timestamps
  createdAt DateTime @default(now())

  @@index([churchId])
  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// ==============================================================================
// PASSWORD RESET TOKEN MODEL
// ==============================================================================
// Secure tokens for password reset flow.
// Tokens are single-use and expire after a short time (default 1 hour).
// ==============================================================================

model PasswordResetToken {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  // User requesting the reset
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  // The reset token - sent via email (in production)
  token     String   @unique
  // Expiration - tokens are short-lived for security
  expiresAt DateTime
  // Whether this token has been used
  usedAt    DateTime?
  // Timestamps
  createdAt DateTime @default(now())

  @@index([churchId])
  @@index([userId])
  @@index([token])
}

// ==============================================================================
// USER INVITE MODEL
// ==============================================================================
// Invitations for new users to join a church.
// Token-based invite flow: Admin creates invite → email sent → user clicks link → sets password.
// ==============================================================================

model UserInvite {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)
  // Invite details
  email     String
  role      UserRole
  // Secure token for the invite link
  token     String   @unique
  // Expiration - invites expire after 7 days by default
  expiresAt DateTime
  // Who sent this invite
  invitedById String?
  // Tracking
  acceptedAt DateTime?
  // Timestamps
  createdAt DateTime @default(now())

  // Email is unique per church for pending invites
  @@unique([churchId, email])
  @@index([churchId])
  @@index([token])
}

// ==============================================================================
// CONTENT MODELS
// ==============================================================================
// All content types are tenant-scoped via churchId.
// Status can be DRAFT or PUBLISHED.
// publishedAt tracks when content was first published.
// ==============================================================================

// Pages - general website pages (About, Contact, etc.)
model Page {
  id        String        @id @default(cuid())
  churchId  String
  church    Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  title     String
  // Body stored as HTML string. Chose HTML over JSON because:
  // 1. Simpler to render without a custom parser
  // 2. Standard format that any rich text editor can produce
  // 3. Easy to sanitize on save
  body      String        @db.Text
  // URL-friendly identifier for the page
  urlPath   String?
  // Optional featured image (URL string, no uploads in Phase 1)
  featuredImageUrl String?

  status      ContentStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // urlPath unique within a church
  @@unique([churchId, urlPath])
  @@index([churchId])
  @@index([status])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, status])
  @@index([churchId, status, createdAt])
}

// Sermons - recorded messages/teachings
model Sermon {
  id        String        @id @default(cuid())
  churchId  String
  church    Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  title       String
  // The date the sermon was preached
  date        DateTime
  speaker     String
  // Scripture reference (e.g., "John 3:16")
  scripture   String?
  // Brief description of the sermon
  description String?       @db.Text
  // Video URL (YouTube, Vimeo, etc.)
  videoUrl    String?
  // Audio URL (for podcast/MP3 version)
  audioUrl    String?

  status      ContentStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([churchId])
  @@index([status])
  @@index([date])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, status])
  @@index([churchId, status, date])
}

// Events - church calendar events
model Event {
  id        String        @id @default(cuid())
  churchId  String
  church    Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  title           String
  startDate       DateTime
  endDate         DateTime?
  location        String?
  // Description as plain text for simplicity
  description     String?   @db.Text
  // Optional registration link
  registrationUrl String?
  // Optional featured image URL
  featuredImageUrl String?

  status      ContentStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([churchId])
  @@index([status])
  @@index([startDate])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, status])
  @@index([churchId, status, startDate])
}

// Announcements - time-sensitive church announcements
model Announcement {
  id        String        @id @default(cuid())
  churchId  String
  church    Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  title     String
  // Body as plain text for simplicity
  body      String        @db.Text
  // When this announcement expires (null = no expiration)
  // Expired announcements are filtered at query time, not auto-deleted
  expiresAt DateTime?

  status      ContentStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([churchId])
  @@index([status])
  @@index([expiresAt])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, status])
  @@index([churchId, status, createdAt])
}

// LeadershipProfile - staff and leadership team members
model LeadershipProfile {
  id        String        @id @default(cuid())
  churchId  String
  church    Church        @relation(fields: [churchId], references: [id], onDelete: Cascade)

  name      String
  // Role/title at the church (e.g., "Senior Pastor", "Worship Director")
  title     String
  bio       String?       @db.Text
  // Photo URL (no uploads in Phase 1)
  photoUrl  String?
  email     String?
  // For ordering profiles in display
  sortOrder Int           @default(0)

  status      ContentStatus @default(DRAFT)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([churchId])
  @@index([status])
  @@index([sortOrder])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, status])
  @@index([churchId, status, sortOrder])
}

// ==============================================================================
// SITE SETTINGS MODEL
// ==============================================================================
// Stores church website configuration including header, footer, service info,
// and SEO defaults. One-to-one relationship with Church.
// ==============================================================================

model SiteSettings {
  id        String @id @default(cuid())
  // Tenant reference - one settings per church
  churchId  String @unique
  church    Church @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Header settings
  logoUrl           String?
  // Navigation: JSON array of {pageId, label, order} objects
  // Stored as JSON for flexibility without a separate NavItem table
  headerNavigation  Json?   @default("[]")

  // Footer settings
  footerText        String?
  // Footer links: JSON array of {pageId, label, order} objects
  footerNavigation  Json?   @default("[]")
  // Social links (simple URL strings)
  facebookUrl       String?
  instagramUrl      String?
  youtubeUrl        String?

  // Service info (displayed on home and/or contact page)
  serviceTimes      String? @db.Text
  address           String?
  phone             String?
  contactEmail      String?

  // SEO defaults
  metaTitle         String?
  metaDescription   String?
  faviconUrl        String?

  // Google Maps embed URL (optional, for contact page)
  mapEmbedUrl       String?

  // Home page configuration
  // If set, this page ID is used as the home page; otherwise default welcome
  homePageId        String?

  // Phase 3: Notification recipients (comma-separated emails)
  // If null, falls back to contactEmail
  prayerNotifyEmails    String?
  volunteerNotifyEmails String?

  // Phase 4: Maintenance mode
  // When true, public site shows "Site is being prepared" message
  // Dashboard remains accessible
  maintenanceMode       Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==============================================================================
// CONTACT SUBMISSION MODEL
// ==============================================================================
// Stores contact form submissions from the public website.
// Tenant-scoped for isolation.
// ==============================================================================

model ContactSubmission {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Form fields
  name      String
  email     String
  message   String   @db.Text

  // Metadata for spam tracking
  ipAddress String?
  userAgent String?

  // Status tracking
  isRead    Boolean  @default(false)

  // Timestamps
  createdAt DateTime @default(now())

  @@index([churchId])
  @@index([createdAt])
  @@index([isRead])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, isRead])
  @@index([churchId, createdAt])
}

// ==============================================================================
// PHASE 3: MEDIA LIBRARY
// ==============================================================================
// Tenant-scoped media storage for images and PDFs.
// Supports multiple sizes for images (original + resized versions).
// ==============================================================================

model Media {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Upload tracking
  uploadedById String
  uploadedBy   User   @relation(fields: [uploadedById], references: [id], onDelete: SetNull)

  // File metadata
  filename     String   // Original filename for display
  mimeType     String   // e.g., "image/jpeg", "application/pdf"
  size         Int      // File size in bytes

  // Storage paths (relative to storage root)
  // For images: stores path to original
  storagePath  String
  // For images: JSON with resized versions { "small": "path", "medium": "path" }
  // For PDFs: null
  variants     Json?

  // Display info
  alt          String?  // Alt text for images

  // Soft delete support
  deletedAt    DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([churchId])
  @@index([uploadedById])
  @@index([mimeType])
  @@index([deletedAt])
  @@index([createdAt])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, deletedAt])
  @@index([churchId, mimeType, deletedAt])
  @@index([churchId, createdAt])
}

// ==============================================================================
// PHASE 3: PRAYER REQUEST FORM
// ==============================================================================
// Private prayer request submissions from the public website.
// Only visible to Admin/Editor in dashboard.
// ==============================================================================

model PrayerRequest {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Form fields (name/email optional for anonymous requests)
  name      String?
  email     String?
  request   String   @db.Text

  // Metadata for spam tracking
  ipAddress String?
  userAgent String?

  // Status tracking
  isRead      Boolean   @default(false)
  isArchived  Boolean   @default(false)
  archivedAt  DateTime?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([churchId])
  @@index([createdAt])
  @@index([isRead])
  @@index([isArchived])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, isRead])
  @@index([churchId, isArchived])
  @@index([churchId, createdAt])
}

// ==============================================================================
// PHASE 3: VOLUNTEER SIGNUP FORM
// ==============================================================================
// Volunteer signup submissions from the public website.
// Visible to Admin/Editor in dashboard.
// ==============================================================================

model VolunteerSignup {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Form fields
  name      String
  email     String
  phone     String?
  // Areas of interest as JSON array of strings
  // Allows flexibility without a separate table
  interests Json?    @default("[]")
  message   String?  @db.Text

  // Metadata for spam tracking
  ipAddress String?
  userAgent String?

  // Status tracking
  isRead      Boolean   @default(false)
  isArchived  Boolean   @default(false)
  archivedAt  DateTime?

  // Timestamps
  createdAt DateTime @default(now())

  @@index([churchId])
  @@index([createdAt])
  @@index([isRead])
  @@index([isArchived])
  // Phase 5: Compound indexes for common queries
  @@index([churchId, isRead])
  @@index([churchId, isArchived])
  @@index([churchId, createdAt])
}

// ==============================================================================
// PHASE 4: CUSTOM DOMAINS
// ==============================================================================
// Team-managed custom domain support for church websites.
// DNS TXT record verification for domain ownership.
// ==============================================================================

// Domain verification status
enum DomainStatus {
  PENDING   // Awaiting DNS verification
  ACTIVE    // Verified and active
  ERROR     // Verification failed or domain issue
}

model CustomDomain {
  id        String       @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church       @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Domain hostname (normalized, lowercase, no trailing dot)
  // e.g., "www.gracechurch.org" or "gracechurch.org"
  hostname  String       @unique

  // Verification status
  status    DomainStatus @default(PENDING)
  // When the domain was verified
  verifiedAt DateTime?
  // Token for DNS TXT record verification
  // Format: fi-verify=<token>
  verificationToken String

  // Admin notes (e.g., "Primary domain", "Redirect to www")
  notes     String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([churchId])
  @@index([hostname])
  @@index([status])
}

// ==============================================================================
// PHASE 4: REDIRECT RULES
// ==============================================================================
// Tenant-scoped 301 permanent redirects for URL management.
// Applied to public routes after tenant resolution.
// ==============================================================================

model RedirectRule {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Source path (relative, starts with /)
  // e.g., "/old-page", "/events/2023"
  sourcePath      String

  // Destination URL (absolute URL or relative path)
  // e.g., "/new-page", "https://external.com/page"
  destinationUrl  String

  // Whether this rule is active
  isActive  Boolean  @default(true)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Source path must be unique per church
  @@unique([churchId, sourcePath])
  @@index([churchId])
  @@index([isActive])
  // Phase 5: Compound indexes for redirect lookup
  @@index([churchId, isActive, sourcePath])
}

// ==============================================================================
// PHASE 4: LAUNCH CHECKLIST
// ==============================================================================
// Structured checklist for site launch preparation.
// Tracks completion status of key launch tasks.
// ==============================================================================

model LaunchChecklistItem {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  church    Church   @relation(fields: [churchId], references: [id], onDelete: Cascade)

  // Item key identifier (e.g., "domain_added", "ssl_active")
  // Predefined keys ensure consistent checklist across churches
  itemKey   String

  // Completion status
  isComplete  Boolean   @default(false)
  completedAt DateTime?
  completedBy String?   // User ID who completed the item

  // Optional notes
  notes     String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Each item key is unique per church
  @@unique([churchId, itemKey])
  @@index([churchId])
}

// ==============================================================================
// PHASE 5: AUDIT LOG
// ==============================================================================
// Tracks sensitive admin actions for security and compliance.
// Immutable log - entries cannot be modified or deleted.
// ==============================================================================

// Audit action types
enum AuditAction {
  // User management
  USER_INVITED
  USER_ROLE_CHANGED
  USER_DEACTIVATED
  USER_REACTIVATED
  // Content lifecycle
  CONTENT_PUBLISHED
  CONTENT_UNPUBLISHED
  CONTENT_DELETED
  // Domain management
  DOMAIN_ADDED
  DOMAIN_VERIFIED
  DOMAIN_REMOVED
  // Redirect management
  REDIRECT_CREATED
  REDIRECT_UPDATED
  REDIRECT_DELETED
  // Site settings
  SETTINGS_UPDATED
  MAINTENANCE_MODE_ENABLED
  MAINTENANCE_MODE_DISABLED
  // Authentication events
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  PASSWORD_RESET_REQUESTED
  PASSWORD_RESET_COMPLETED
}

// Entity types for audit logging
enum AuditEntityType {
  USER
  USER_INVITE
  PAGE
  SERMON
  EVENT
  ANNOUNCEMENT
  LEADERSHIP_PROFILE
  CUSTOM_DOMAIN
  REDIRECT_RULE
  SITE_SETTINGS
  SESSION
}

model AuditLog {
  id          String          @id @default(cuid())
  // Tenant reference
  churchId    String

  // Who performed the action (null for system actions or failed logins)
  actorUserId String?
  actorEmail  String?         // Captured at time of action for historical record
  actorIp     String?         // IP address at time of action

  // What action was performed
  action      AuditAction

  // What entity was affected
  entityType  AuditEntityType
  entityId    String?         // ID of affected entity (null for some actions)

  // Additional context (JSON)
  // e.g., { "oldRole": "VIEWER", "newRole": "EDITOR" }
  metadata    Json?

  // Request context
  requestId   String?         // Correlation ID for request tracing
  userAgent   String?

  // Timestamp (immutable)
  createdAt   DateTime        @default(now())

  // Compound indexes for efficient querying
  @@index([churchId, createdAt])
  @@index([churchId, action])
  @@index([churchId, entityType])
  @@index([churchId, actorUserId])
  @@index([actorUserId])
  @@index([createdAt])
}

// ==============================================================================
// PHASE 5: LOGIN ATTEMPTS (Account Lockout)
// ==============================================================================
// Tracks failed login attempts for account lockout protection.
// ==============================================================================

model LoginAttempt {
  id        String   @id @default(cuid())
  // Tenant reference
  churchId  String
  // Email attempted (normalized lowercase)
  email     String
  // IP address of attempt
  ipAddress String
  // Whether the attempt succeeded
  success   Boolean
  // Reason for failure (if applicable)
  failReason String?
  // Timestamp
  createdAt DateTime @default(now())

  // Indexes for lockout queries
  @@index([churchId, email, createdAt])
  @@index([ipAddress, createdAt])
  @@index([createdAt])
}
